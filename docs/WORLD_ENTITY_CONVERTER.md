# World Entity Converter

**Module:** `src/world_entity_converter.py`  
**Purpose:** Convert trajectory CSV files to WORLD_ENTITY simulation format

---

## Overview

The World Entity Converter processes trajectory CSV files (generated by the spatial group simulator) and converts them into WORLD_ENTITY configuration format for simulation environments. It creates unique keys for each object, generates individual trajectory files, and produces consolidated entity definition files.

---

## Features

✅ **Unique Key Assignment** - Assigns incrementing integer keys starting at 1  
✅ **Tab-Delimited Output** - Creates properly formatted trajectory files  
✅ **WORLD_ENTITY Strings** - Generates complete entity configuration  
✅ **Consolidated Output** - Single file with all entity definitions  
✅ **Multiple File Support** - Process multiple CSV files with consistent key numbering  
✅ **Directory Creation** - Automatically creates `./trajectories/G/` directory structure  

---

## Input Format

**Trajectory CSV** (from spatial group simulator):
```csv
object_id,group_id,category,time_percent,north,east,down
1,1,1,0.0,104.97,48.62,6.48
1,1,1,2.04,104.54,48.19,9.35
1,1,1,4.08,104.11,47.76,12.23
...
```

**Required Columns:**
- `object_id`: Unique object identifier
- `group_id`: Group identifier
- `time_percent`: Time as percentage (0-100%)
- `north`: North coordinate (meters, NED)
- `east`: East coordinate (meters, NED)
- `down`: Down coordinate (meters, NED)

---

## Output Format

### 1. Individual Trajectory Files

**Location:** `./trajectories/G/G_<key>_.txt`  
**Format:** Tab-delimited  

**Columns:**
- `FIELDS`: Empty string (not NaN)
- `FRAME`: 0.0 (constant)
- `TIME`: Time percentage
- `POS_N`: North position
- `POS_E`: East position
- `POS_D`: Down position

**Example:** `./trajectories/G/G_1_.txt`
```
FIELDS	FRAME	TIME	POS_N	POS_E	POS_D
	0.0	0.0	224.84	93.09	32.38
	0.0	2.04	223.94	92.20	38.39
	0.0	4.08	223.05	91.31	44.40
```

### 2. WORLD_ENTITY Strings

**Format:**
```
WORLD_ENTITY {
    name = G_<key>
    position = "<first_north>, <first_east>, <first_down>"
    scale =
    stateAttsLoadFilename = './trajectories/G/G_<key>_.txt'
}
```

**Example:**
```
WORLD_ENTITY {
    name = G_1
    position = "224.84, 93.09, 32.38"
    scale =
    stateAttsLoadFilename = './trajectories/G/G_1_.txt'
}
```

### 3. Consolidated File

**Location:** `./trajectories/all_G_WORLD_ENTITIES.txt`  
**Contents:** All WORLD_ENTITY strings concatenated with blank lines between

---

## Usage

### Command Line

**Single File:**
```bash
python src/world_entity_converter.py results/trajectories.csv
```

**Multiple Files:**
```bash
python src/world_entity_converter.py file1.csv file2.csv file3.csv
```

**Custom Output Directory:**
```bash
python src/world_entity_converter.py trajectories.csv --output-dir my_output/
```

### Python API

**Single File:**
```python
from pathlib import Path
from src.world_entity_converter import convert_trajectory_csv

result = convert_trajectory_csv(
    csv_path=Path('results/trajectories.csv'),
    output_dir=Path('./trajectories')
)

print(f"Created {result['num_entities']} entities")
print(f"Consolidated file: {result['consolidated_file']}")
```

**Multiple Files:**
```python
from src.world_entity_converter import convert_multiple_csvs

csv_files = [
    Path('results/scenario1_trajectories.csv'),
    Path('results/scenario2_trajectories.csv'),
    Path('results/scenario3_trajectories.csv')
]

result = convert_multiple_csvs(
    csv_paths=csv_files,
    output_dir=Path('./trajectories')
)

print(f"Processed {len(result['files_processed'])} files")
print(f"Created {result['num_entities']} total entities")
```

**Using WorldEntityConverter Class:**
```python
from src.world_entity_converter import WorldEntityConverter
from pathlib import Path

# Create converter
converter = WorldEntityConverter(output_dir=Path('./trajectories'))

# Process files
result = converter.convert_csv_to_world_entities(
    Path('results/trajectories.csv')
)

# Access results
for key, entity_string in result['entity_strings'].items():
    print(f"Entity {key}:")
    print(entity_string)
    print()
```

---

## Key Assignment

### How Keys Work

1. **Unique Combination:** Each unique `(object_id, group_id)` pair gets a unique key
2. **Sequential:** Keys start at 1 and increment by 1
3. **Consistent:** Same combination always gets same key within a conversion
4. **Persistent Across Files:** When processing multiple files, keys continue incrementing

### Example

**Input:**
```csv
object_id,group_id,...
1,1,...        # Gets key 1
1,1,...        # Same key 1
2,1,...        # Gets key 2
3,2,...        # Gets key 3
```

**Keys Assigned:**
- Object 1, Group 1 → Key 1
- Object 2, Group 1 → Key 2
- Object 3, Group 2 → Key 3

---

## Output Files

### Directory Structure

```
./trajectories/
├── G/
│   ├── G_1_.txt
│   ├── G_2_.txt
│   ├── G_3_.txt
│   ├── ...
│   └── G_N_.txt
└── all_G_WORLD_ENTITIES.txt
```

### File Naming Convention

- **Trajectory Files:** `G_<key>_.txt`
  - Example: `G_1_.txt`, `G_2_.txt`, `G_3_.txt`
  - Note the underscore before `.txt`

- **Consolidated File:** `all_G_WORLD_ENTITIES.txt`
  - Single file with all entity definitions

---

## Complete Example

### Input CSV

```csv
object_id,group_id,category,time_percent,north,east,down
1,1,1,0.0,100.0,50.0,0.0
1,1,1,10.0,105.0,52.0,-1.0
1,1,1,20.0,110.0,54.0,-2.0
2,1,1,0.0,150.0,60.0,5.0
2,1,1,10.0,155.0,62.0,6.0
```

### Generated Trajectory File (`G_1_.txt`)

```
FIELDS	FRAME	TIME	POS_N	POS_E	POS_D
	0.0	0.0	100.0	50.0	0.0
	0.0	10.0	105.0	52.0	-1.0
	0.0	20.0	110.0	54.0	-2.0
```

### Generated WORLD_ENTITY

```
WORLD_ENTITY {
    name = G_1
    position = "100.0, 50.0, 0.0"
    scale =
    stateAttsLoadFilename = './trajectories/G/G_1_.txt'
}
```

---

## Integration with Spatial Groups

### Complete Workflow

1. **Generate Trajectories:**
```bash
python src/spatial_demo.py --save
```

2. **Convert to WORLD_ENTITY Format:**
```bash
python src/world_entity_converter.py \
    results/20260212_1743_three_groups_different_categories_trajectories.csv
```

3. **Output:**
- `./trajectories/G/G_1_.txt` through `G_N_.txt`
- `./trajectories/all_G_WORLD_ENTITIES.txt`

### Batch Process All Scenarios

```bash
python src/world_entity_converter.py results/*_trajectories.csv
```

This will:
- Process all trajectory CSV files
- Assign unique keys across all files
- Generate consolidated entity file

---

## API Reference

### WorldEntityConverter Class

```python
class WorldEntityConverter:
    def __init__(self, output_dir: Path = Path('./trajectories'))
```

**Methods:**

#### `create_unique_keys(trajectories_df: pd.DataFrame) -> pd.DataFrame`
Create unique keys for each object_id/group_id combination.

#### `format_trajectory_data(key_data: pd.DataFrame) -> pd.DataFrame`
Format trajectory data with FIELDS, FRAME, TIME, POS_N, POS_E, POS_D columns.

#### `save_trajectory_file(key: int, trajectory_df: pd.DataFrame) -> Path`
Save trajectory file as `./trajectories/G/G_<key>_.txt`.

#### `create_world_entity_string(key: int, key_data: pd.DataFrame) -> str`
Create WORLD_ENTITY configuration string.

#### `convert_csv_to_world_entities(csv_path: Path) -> Dict`
Main conversion function. Returns:
```python
{
    'entity_strings': {1: 'WORLD_ENTITY {...}', ...},
    'trajectory_files': {1: Path('...'), ...},
    'consolidated_file': Path('all_G_WORLD_ENTITIES.txt'),
    'num_entities': 12
}
```

#### `process_multiple_csvs(csv_paths: list) -> Dict`
Process multiple CSV files with consistent key numbering.

---

## Convenience Functions

### `convert_trajectory_csv(csv_path, output_dir='./trajectories')`
Convert single CSV file.

### `convert_multiple_csvs(csv_paths, output_dir='./trajectories')`
Convert multiple CSV files.

---

## Testing

### Run Tests

```bash
pytest tests/test_world_entity_converter.py -v
```

### Test Coverage

11 comprehensive tests covering:
- Unique key generation
- Trajectory file formatting
- WORLD_ENTITY string creation
- File I/O
- Multiple file processing
- Edge cases

**Status:** ✅ All 11 tests passing

---

## Coordinate System

### NED Coordinates

All positions use **North-East-Down (NED)** coordinate system:

- **POS_N:** North coordinate (meters)
  - Positive = North
  - Negative = South
  
- **POS_E:** East coordinate (meters)
  - Positive = East
  - Negative = West
  
- **POS_D:** Down coordinate (meters)
  - Positive = Below reference (underground/submerged)
  - Negative = Above reference (elevated/flying)

### Position Format

WORLD_ENTITY position uses format: `"N, E, D"`

Example:
- `"100.0, 50.0, 0.0"` = 100m north, 50m east, at reference altitude
- `"100.0, 50.0, -10.0"` = 100m north, 50m east, 10m above reference
- `"100.0, 50.0, 10.0"` = 100m north, 50m east, 10m below reference

---

## Notes

### Empty FIELDS Column

- The FIELDS column is intentionally empty (empty string, not NaN)
- This matches simulation environment requirements
- When reading trajectory files, use `keep_default_na=False` in pandas:

```python
df = pd.read_csv(filepath, sep='\t', keep_default_na=False)
```

### FRAME Column

- Always set to 0.0 for all rows
- Required by simulation environment format

### File Path Format

- Uses relative paths: `'./trajectories/G/G_<key>_.txt'`
- Single quotes in WORLD_ENTITY string
- Forward slashes for path separators

---

## Troubleshooting

### Issue: FIELDS column shows NaN

**Solution:** When reading trajectory files, use:
```python
pd.read_csv(filepath, sep='\t', keep_default_na=False)
```

### Issue: Directory not found

**Solution:** The converter automatically creates `./trajectories/G/` directory. If permission issues occur, manually create the directory first.

### Issue: Keys not sequential

**Solution:** Keys are assigned based on order of unique `(object_id, group_id)` combinations in the CSV. This is deterministic but may not match object_id order.

---

## Performance

**Typical Performance:**
- 10 objects: < 0.1 seconds
- 100 objects: < 0.5 seconds
- 1000 objects: < 2 seconds

**Output Size:**
- ~50 bytes per trajectory point
- Example: 50 time points = ~2.5 KB per trajectory file

---

## Examples from Project

### Wide Dispersal Scenario

**Input:** `results/20260212_1743_wide_dispersal_trajectories.csv`  
**Objects:** 9  
**Keys:** 1-9  
**Output:** 9 trajectory files + consolidated entity file

### Multiple Scenarios

```bash
python src/world_entity_converter.py \
    results/20260212_1743_three_groups_different_categories_trajectories.csv \
    results/20260212_1743_tight_cluster_trajectories.csv
```

**Result:**
- 26 total entities (12 + 14)
- Keys 1-26
- All in single consolidated file

---

## Related Documentation

- `docs/GROUP_SCHEDULER.md` - Group scheduling and timing
- `SPATIAL_GROUPS_FEATURE_COMPLETE.md` - Spatial group simulation
- `TDD_SPATIAL_GROUPS_EVIDENCE.md` - Spatial groups TDD process

---

**Created:** February 12, 2026  
**Tests:** 11/11 passing  
**Status:** ✅ Production ready

